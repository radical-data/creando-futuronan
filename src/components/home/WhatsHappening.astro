---
import EventsCalendar from './EventsCalendar.svelte';
import { normaliseLocale, useTranslations } from "../../i18n/utils";
import type { Lang } from "../../i18n/ui";

interface OpenCall {
  isOpen: boolean;
  title: string;
  deadlineISO?: string;
  applyLinks?: { label: string; href: string }[];
}
interface EventItem {
  title: string;
  dateISO: string;
  island: string;
  href: string;
  programme?: string;
  isLongEvent?: boolean;
  endDateISO?: string;
}

const { openCall, events = [], lang: langProp = "pap" }: { openCall?: OpenCall; events?: EventItem[]; lang?: Lang } =
  Astro.props;

const lang: Lang = normaliseLocale(langProp);
const t = useTranslations(lang);

const tz = "America/Aruba"; // UTCâˆ’4 year-round
const fmt = (iso: string, locale = "en-AW") =>
  new Intl.DateTimeFormat(locale, {
    timeZone: tz,
    day: "2-digit",
    month: "short",
    hour: "2-digit",
    minute: "2-digit",
  }).format(new Date(iso));
---

<section class="py-10 lg:py-14 border-t border-black/10">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
    {
      openCall?.isOpen ? (
        <div class="card p-8 border-2 border-[--color-sustain]/20">
          <div class="flex items-center gap-2 mb-3">
            <span class="stream-indicator stream-indicator-sustain"></span>
            <div class="text-xs uppercase tracking-wide font-bold" style="color: var(--color-sustain);">
              {t("home.openCall")}
            </div>
          </div>
          <h2 class="h2 mb-3">
            {openCall.title}
          </h2>
          {openCall.deadlineISO && (
            <p class="text-black/75 mb-6">
              {t("home.deadline")} {fmt(openCall.deadlineISO)}
            </p>
          )}
          <div class="flex flex-wrap gap-3">
            {(openCall.applyLinks ?? []).map((link) => (
              <a
                class="btn-primary btn-md btn-cap font-bold"
                style="background: var(--color-sustain); border-color: var(--color-sustain);"
                href={link.href}
              >
                {link.label}
              </a>
            ))}
            <a
              href="/sustain#faq"
              class="btn-outline btn-md btn-cap font-bold"
              style="border-color: var(--color-sustain); color: var(--color-sustain);"
            >
              {t("programme.faqs")}
            </a>
          </div>
        </div>
      ) : (
        <>
          <div class="flex items-center justify-between">
            <h2 class="h2">
              {t("home.upcomingEvents")}
            </h2>
          </div>
          
          <!-- Calendar Component -->
          <div class="mt-6">
            <EventsCalendar events={events} openCall={openCall} lang={lang} client:visible />
          </div>
          
        </>
      )
    }
  </div>
</section>
