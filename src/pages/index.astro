---
import SiteLayout from "../layouts/Layout.astro";
import Hero from "../components/home/Hero.astro";
import Programmes from "../components/home/Programmes.astro";
import WhatsHappening from "../components/home/WhatsHappening.astro";
import WhyCreando from "../components/home/WhyCreando.astro";
import Partners from "../components/home/Partners.astro";
import ClosingCTA from "../components/home/ClosingCTA.astro";
import UrgencyBanner from "../components/UrgencyBanner.svelte";
import heroImage from "../assets/hero.png";

import { getCollection } from "astro:content";
import { normaliseLocale, useTranslations } from "../i18n/utils";
import type { Lang } from "../i18n/ui";

const lang: Lang = normaliseLocale(Astro.currentLocale);
const t = useTranslations(lang);

function entryMatchesLocale(entryId: string, lang: Lang) {
  return entryId.startsWith(`${lang}/`);
}

const programmes = (await getCollection("programmes"))
  .filter((p) => entryMatchesLocale(p.id, lang))
  .map((p) => p.data);

const partnerCards = (await getCollection("partners"))
  .filter((p) => entryMatchesLocale(p.id, lang))
  .map((p) => p.data);

const events = (await getCollection("events"))
  .filter((e) => entryMatchesLocale(e.id, lang))
  .map((e) => ({
    ...e.data,
    dateISO: e.data.dateISO.toISOString(),
  }))
  .sort((a, b) => new Date(a.dateISO).getTime() - new Date(b.dateISO).getTime());

const openCalls = (await getCollection("open-calls"))
  .filter((o) => entryMatchesLocale(o.id, lang))
  .map((o) => o.data);

// Find active open call
const activeOpenCall =
  openCalls.find((call) => {
    if (!call.openISO || !call.closeISO) return false;
    const now = new Date();
    const openDate = new Date(call.openISO);
    const closeDate = new Date(call.closeISO);
    return now >= openDate && now <= closeDate;
  }) ?? null;

const headline = t("home.headline");
const sub = t("home.sub");
---

<SiteLayout title="Creando Futuronan">
  <UrgencyBanner openCall={activeOpenCall} lang={lang} client:load />
  
  <Hero
    headline={headline}
    sub={sub}
    ctas={[
      { label: "Join Creando Spark", href: "/spark" },
      { label: "Apply to Creando Sustain", href: "/sustain" },
    ]}
    image={heroImage}
    muxPlaybackId="YbgUMhM7Hyd00NxY1bTW35AWn4oO5r3MgUcL71RHdTfU"
  />

  <!-- Programmes -->
  <Programmes cards={programmes} />

  <!-- What's happening now (Open Call or Events) -->
  <WhatsHappening openCall={activeOpenCall} events={events} lang={lang} />

  <!-- Why Creando -->
  <WhyCreando />

  <!-- Partners -->
  <Partners items={partnerCards} />

  <!-- Closing CTA -->
  <ClosingCTA />
</SiteLayout>
